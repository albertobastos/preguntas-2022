<!DOCTYPE html>
<html>
  <meta charset="utf-8" />
  <head>
    <title>Examinador 2.0</title>
  </head>
  <style type="text/css">
  button.right {
    background-color: lightgreen;
  }
  button.wrong {
    background-color: red;
    color: white;
  }
  </style>
</html>

<div id="nojs">
  Sin JavaScript hay poco que hacer, que no cobro por esto.
</div>

<div id="outer" style="display: none;">
  <h1>Examinador 2.0</h1>
  <div id="config">
    <p>Elige qué temas incluir:</p>
    <ul>
      <li><button onclick="handlers.config.selectAll();">Seleccionar todos</button></li>
    </ul>
    <ul id="config-chapters">
      <!--li>
        <input type="checkbox" data-num="x" data-amount="n" checked="checked" />
        <button>Tema N.</button> Bla bla bla bla. <span>(N preguntas)</span>
      </li-->
    </ul>
    <ul>
      <li><input type="checkbox" id="config-shuffle" /> Barajar respuestas</li>
      <li>Cuántas preguntas: <input type="text" id="config-amount" />
        <span>(máx: <span id="config-max"></span>)</span></li>
    </ul>
    <button onclick="handlers.config.startExam();">Empezar</button>
  </div>
  <div id="exam">
    <div id="exam-stats">
      <ul>
        <li>Aciertos: <span id="exam-stats-right">N</span></li>
        <li>Fallos: <span id="exam-stats-wrong">N</span></li>
        <li>Sin contestar: <span id="exam-stats-blank">N</span></li>
        <li>Nota (sobre 60): <span id="exam-stats-score60">N</span></li>
        <li>Nota (sobre 10): <span id="exam-stats-score10">N</span></li>
      </ul>
      <ul>
        <li><button>Nuevo examen</button></li>
        <li><button>Ver solo fallos</button></li>
        <li><button>Exportar seleccionadas</button></li>
        <li><button>Repetir fallos</button></li>
        <li><button>Estadísticas</button></li>
      </ul>
    </div>
    <div id="exam-sheet">
        <!--div>
          <p>
            <input type="checkbox" name="exam-question-N" /><span>N. </span>
            <span>Bla bla bla bla bla</span>
          </p>
          <ul>
            <li><button>a) foo</button></li>
            <li><button>b) bar</button></li>
            <li><button>c) xyx</button></li>
            <li><button>d) culo</button></li>
          </ul>
        </div-->
    </div>
  </div>
</div>

<script type="text/javascript">
const DATA = ##DATA##;

/*
DATA [ // un item por tema
  {
    num // int, numeración original del tema
    title // string, nombre del tema
    questions [ // un item por cada pregunta del tema
                // aquí ya solo llegan preguntas que cumplen todo lo
                // necesario para incluirse en un examen
      {
        n // int, numeración original de la pregunta dentro del tema
        a // char, opción (siguiendo orden original) con la respuesta correcta
        q // string, enunciado de la pregunta
        o [ // un item por cada posible respuesta
          {char x} // texto de la respuesta para la opción etiquetada como {x}
                   // en el orden original
        ]
      }
    ]
  }
]
*/

const STATE = {
  view: "config",
  stats: {
    chapters: new Map() // es un Map(Map)
                         // en el que questions[N][M] devuelve las estadísticas
                         // de la pregunta M en el tema N
  },
  currentExam: {
    questions: null,
    total: null,
    right: null,
    wrong: null,
    score60: 0,
    score10: 0
  }
};

DATA.forEach(c => {
  const cm = new Map();
  c.questions.forEach(q => {
    cm.set(q.n, {
      chapter: c,
      question: q,
      appearances: 0,
      answered: 0,
      right: 0,
      wrong: 0,
    });
  });
  STATE.stats.chapters.set(c.num, cm);
});

const DOM = {
  nojs: document.getElementById('nojs'),
  outer: document.getElementById('outer'),
  config: {
    chapters: document.getElementById('config-chapters'),
    chapterChecks: () => {
      const checks = [...DOM.config.chapters.getElementsByTagName('input')]
        .filter(input => input.type === "checkbox");
      DOM.config.chapterChecks = () => checks;
      return checks;
    },
    amount: document.getElementById('config-amount'),
    max: document.getElementById('config-max'),
    shuffle: document.getElementById('config-shuffle')
  },
  exam: {
    sheet: document.getElementById('exam-sheet'),
    right: document.getElementById('exam-stats-right'),
    wrong: document.getElementById('exam-stats-wrong'),
    blank: document.getElementById('exam-stats-blank'),
    score60: document.getElementById('exam-stats-score60'),
    score10: document.getElementById('exam-stats-score10')
  }
};

const handlers = {
  config: {
    selectAll: function() {
      DOM.config.chapterChecks().forEach(chk => chk.checked = true);
      helpers.config.updateConfigAmountMax();
    },
    checkChapter: function(checkbox) {
      helpers.config.updateConfigAmountMax();
    },
    onlyChapter: function(button) {
      const num = button.getAttribute("data-num");
      DOM.config.chapterChecks().forEach(check => 
        check.checked = check.getAttribute("data-num")===num ? "checked" : "");
      helpers.config.updateConfigAmountMax();
      DOM.config.amount.value = helpers.config.getConfigMaxAmount();
    },
    startExam: function() {
      let n = Number(DOM.config.amount.value);
      if (n > helpers.config.getConfigMaxAmount()) {
        alert("Solo puedes elegir hasta " + helpers.config.getConfigMaxAmount()
          + " preguntas.");
        return;
      }
      const shuffleAnswers = DOM.config.shuffle.checked;
      const chapterNums = DATA
        .map(c => c.num)
        .filter(cnum => DOM.config.chapterChecks().some(cc =>
          cc.checked && Number(cc.getAttribute("data-num")) === cnum));
      const candidates =
        [...helpers.config.buildQuestionCandidates(chapterNums).values()];
      const cn = candidates.length;
      const qss = [];
      for (let ci=0; n>0; ci=(ci+1)%cn) {
        if (candidates[ci].length > 0) {
          qss.push(candidates[ci].pop());
          n--;
        }
      }
      shuffle(qss);
      const questions = [];
      for (const qs of qss) {
        qs.appearances++;
        questions.push(toExamQuestion(qs.chapter, qs.question, shuffleAnswers));
      }

      helpers.exam.newExam(questions);
    }
  },
  exam: {
    submitAnswer(button, qIndex, qOpt) {
      const q = STATE.currentExam.questions[qIndex];
      if (q.answered == null) return;
      q.answered = qOpt;
      const optionButtons = button.parentNode.parentNode.querySelectorAll('button');
      for (const ob of optionButtons) {
        const opt = ob.getAttribute("opt");
        const cl = helpers.exam.determineAnswerClass(q, opt);
        if (cl != '') ob.classList.add(cl);
      }
      const qstat = STATE.stats.chapters.get(q.chapter).get(q.n);
      const estat = STATE.currentExam;
      qstat.answered++;
      if (q.answer === qOpt) {
        qstat.right++;
        estat.right++;
      } else {
        qstat.wrong++;
        estat.wrong++;
      }
      helpers.exam.updateScore();
      helpers.exam.renderScore();
    }
  }
};

const helpers = {
  config: {
    reset: function() {
      DATA.forEach(c => {
        helpers.config.addChapter(c.num, c.title, c.questions.length);
      });
      helpers.config.updateConfigAmountMax();
      DOM.config.amount.value = 100;
    },
    addChapter: function(num, title, nQuestions) {
      const li = document.createElement('li');
      const html = `\
<input
  data-num="${num}"
  data-amount="${nQuestions}"
  type="checkbox"
  checked="checked"
  onclick="handlers.config.checkChapter(this);" />
<button
  data-num="${num}"
  onclick="handlers.config.onlyChapter(this);"
>Tema ${num}.</button> ${title} <span>(${nQuestions} preguntas)</span>`;
      li.innerHTML = html;
      DOM.config.chapters.appendChild(li);
    },
    getConfigMaxAmount: function() {
      return DOM.config.chapterChecks()
        .filter(c => c.checked)
        .map(c => Number(c.getAttribute("data-amount")))
        .reduce((acc, curr) => acc+curr, 0);
    },
    updateConfigAmountMax: function() {
      const max = helpers.config.getConfigMaxAmount();
      DOM.config.max.innerHTML = max;
    },
    buildQuestionCandidates: function(chapters) {
      const candidates = new Map(); // chapter num => question stats sorted
      chapters.forEach(cnum => {
        const appearancesMap = new Map();
        for (const qs of STATE.stats.chapters.get(cnum).values()) {
          if (!appearancesMap.has(qs.appearances))
            appearancesMap.set(qs.appearances, []);
          appearancesMap.get(qs.appearances).push(qs);
        }
        const ccands = [];
          [...appearancesMap.keys()].sort().reverse()
            .forEach(n => ccands.push(...shuffle(appearancesMap.get(n))));
        candidates.set(cnum, ccands);
      });
      return candidates;
    }
  },
  exam: {
    newExam: function(questions) {
      const e = STATE.currentExam;
      e.questions = questions;
      e.total = questions.length;
      e.right = 0;
      e.wrong = 0;
      helpers.exam.updateScore();
      helpers.exam.renderScore();
      helpers.exam.renderSheet();
    },
    updateScore: function() {
      const e = STATE.currentExam;
      e.score60 = Math.floor((e.right/e.total) *6000) / 100;
      e.score10 = Math.floor(((e.score60 * 10) / 60) * 100) / 100;
    },
    renderSheet: function() {
      helpers.exam.clearExam();
      const qs = STATE.currentExam.questions;
      for (let i=0; i<qs.length; i++)
        helpers.exam.addQuestion(i+1, qs[i]);
    },
    renderScore: function() {
      const e = STATE.currentExam;
      const d = DOM.exam;
      d.right.innerHTML = e.right;
      d.wrong.innerHTML = e.wrong;
      d.blank.innerHTML = e.total - e.right - e.wrong;
      d.score60.innerHTML = e.score60;
      d.score10.innerHTML = e.score10;
    },
    clearExam: function() {
      DOM.exam.sheet.innerHTML = '';
    },
    addQuestion: function(i, q) {
      const div = document.createElement('div');
      const lis = Object.entries(q.options).map(([opt, text]) =>
`<li><button
  data-i="${i}"
  data-opt="${opt}"
  class="${helpers.exam.determineAnswerClass(q, opt)}"
  onClick="handlers.exam.submitAnswer(this, ${i}, '${opt}')"
>${opt}) ${text}</button></li>`).join('');
      div.innerHTML = `\
<p>
  <input type="checkbox" name="exam-question-${i}" />
  <span title="${q.chapter}.${q.num}">${i}. </span>
  <span>${q.text}</span>
</p>
<ul>${lis}</ul>
`;
      DOM.exam.sheet.appendChild(div);
    },
    determineAnswerClass: function(q, opt) {
      if (q.answered == null)
        return '';
      else if (q.answered === opt && opt !== q.answer)
        return 'wrong';
      else if (q.answer === opt)
        return 'right';
      else
        return '';
    }
  },
};

// https://stackoverflow.com/posts/2450976/revisions
function shuffle(array) {
  let currentIndex = array.length,  randomIndex;

  // While there remain elements to shuffle.
  while (currentIndex != 0) {

    // Pick a remaining element.
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;

    // And swap it with the current element.
    [array[currentIndex], array[randomIndex]] = [
      array[randomIndex], array[currentIndex]];
  }

  return array;
}

function toExamQuestion(c, q, shuffleAnswers) {
  let options = {...q.o};
  let answer = q.a;
  if (shuffleAnswers) {
    const keys = Object.keys(options);
    const newOrder = shuffle([...keys]);
    for (let i=0; i<keys.length; i++) {
      const oldKey = newOrder[i], newKey = keys[i];
      options[newKey] = q.o[oldKey];
      if (q.a === oldKey) answer = newKey;
    }
  }
  return {
    chapter: c.num,
    num: q.n,
    text: q.q,
    options,
    answer,
    answered: null
  };
}

(function init() {
  helpers.config.reset();
  DOM.nojs.style.display = 'none';
  DOM.outer.style.display = '';
})();

</script>