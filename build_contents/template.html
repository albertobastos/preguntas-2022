<!DOCTYPE html>
<html>
  <meta charset="utf-8" />
  <head>
    <title>Examinador</title>
  </head>
  <style type="text/css">
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 1em;
    }
    div.outer {
      margin-left: auto;
      margin-right: auto;
      width: 70%;
    }
    section.exam {
      display: none;
    }
    section.results {
      display: none;
    }
    li.chapter {
      margin-bottom: .5em;
    }
    li.chapter i {
      color: #666;
    }
    section.exam_stats {
      background-color: #eee;
      margin-top: 1em;
      padding: .5em 1em .5em 1em;
    }
    section.exam_stats span {
      font-weight: bold;
      margin-right: 1em;
    }
    section.exam_stats span#exam_score {
      margin-right: 0;
    }
    #exam_right {
      color: green;
    }
    #exam_wrong {
      color: red;
    }
    #exam_pending {
      color: darkorange;
    }
    #exam_questions {
      font-size: 1.2em;
    }
    #exam_questions li {
      margin-bottom: 1em;
    }
    #exam_questions button {
      width: 100%;
      margin: .5em 0 0 0;
      border: 1px solid #000;
      padding: .5em;
      text-align: left;
      font-size: 1em;
      background-color: #F9F9F9;
    }
    #exam_questions button:hover {
      background-color: #F0F0F0;
      cursor: pointer;
    }
    #exam_questions button.right {
      background-color: lightgreen;
    }
    #exam_questions  button.wrong {
      background-color: lightpink;
    }
  </style>
</html>

<div class="outer">
  <h1>Examinador</h1>

  <section class="page config">
    <button onclick="startExam();">Empezar</button>
    <p>¿Cuántas preguntas quieres?</p>
    <input id="config_questions" value="100" />
    <p>Elige qué temas incluir:</p>
    <ul id="config_chapters">
        <!-- to fill -->
        <li class="chapter"><input type="checkbox" name="config_chapter" value="1" checked="checked" /><strong>Tema 1.</strong> Título del capítulo. <i>(N preguntas)</i>.</li>
    </ul>
    <button onclick="startExam();">Empezar</button>
  </section>
  
  <section class="page exam">
    <button onclick="gotoPage('config');">Nuevo examen</button>
    <section class="exam_stats">
      <p>
        Aciertos: <span id="exam_right">-</span>
        Fallos: <span id="exam_wrong">-</span>
        No contestadas: <span id="exam_pending">-</span>
        Resultado: <span id="exam_score">-</span><span>/60</span>
      </p>
    </section>
    <section>
      <ol id="exam_questions">
        <!-- to fill -->
        <li title="Tema y numero de pregunta">Enunciado de la pregunta
          <button id="q-0-a" onclick="answerQuestion(1, 'a')">Texto de la pregunta</button>
          <button id="q-0-a" onclick="answerQuestion(1, 'a')">Texto de la pregunta</button>
          <button id="q-0-a" onclick="answerQuestion(1, 'a')">Texto de la pregunta</button>
          <button id="q-0-a" onclick="answerQuestion(1, 'a')">Texto de la pregunta</button>    
        </li>  
      </ol>
    </section>
    <button onclick="gotoPage('config');">Nuevo examen</button>
  </section>

  <section class="page results">
    <button onclick="startExam();">Nuevo examen</button>
  </section>
</div>

<script type="text/javascript">
const DATA = ##DATA##;

let exam_state = {
  questions: null,
  right: 0,
  wrong: 0,
  pending: 0,
  score: 0
};

DATA.forEach(chapter => {
  chapter.questions.forEach(question => question.c = chapter.num);
});

renderConfig();

function renderConfig() {
  let s ="";
  DATA.forEach(chapter => {
    s += `<li class="chapter"><input type="checkbox" name="config_chapter" value="${chapter.num}" checked="checked" /><strong>Tema ${chapter.num}.</strong> ${chapter.title}. <i>(${chapter.questions.length} preguntas)</i>.</li>`;
  });
  document.getElementById("config_chapters").innerHTML = s;
}

function startExam() {
  const selected = new Set([...document.querySelectorAll("input[name=config_chapter]:checked")].map(check => Number(check.value)));
  const questions = DATA
    .filter(chapter => selected.has(chapter.num))
    .reduce((acc, chapter) => {
      acc.push(...chapter.questions);
      return acc;
    }, []);
  const howMany = Number(document.getElementById("config_questions").value);
  if (howMany > questions.length) {
    alert("Seleccione más temas para alcanzar " + howMany + " preguntas (" + questions.length + ")");
    return;
  }
  resetExam(shuffleArray(questions).slice(0, howMany));
  renderExamPage();

  gotoPage("exam");
}

function resetExam(questions) {
  exam_state.questions = questions;
  exam_state.answers = new Array(questions.length).fill(null);
  exam_state.current = 0;
  exam_state.right = exam_state.wrong = exam_state.score = 0;
  exam_state.pending = exam_state.questions.length;
}

const exam_right = document.getElementById("exam_right");
const exam_wrong = document.getElementById("exam_wrong");
const exam_pending  = document.getElementById("exam_pending");
const exam_question  = document.getElementById("exam_question");
const exam_score  = document.getElementById("exam_score");
const exam_questions  = document.getElementById("exam_questions");
function renderExamPage() {
  updateExamStats();

  let s = "";
  exam_state.questions.forEach((q,i) => {
    s += `<li title="Tema ${q.c} Pregunta ${q.n}">${q.q}`;
    Object.keys(q.o).forEach(a => {
      s += `<button id="answer-${i}-${a}" onclick="answerQuestion(${i}, '${a}');">${a}) ${q.o[a]}</button>`;
    });
    s += `</li>`;
  });
  exam_questions.innerHTML = s;
}

function updateExamStats() {
  exam_right.innerHTML = exam_state.right;
  exam_wrong.innerHTML = exam_state.wrong;
  exam_pending.innerHTML = exam_state.pending;
  exam_score.innerHTML = exam_state.score;
}

function answerQuestion(question, answer) {
  if (exam_state.answers[question] != null) return; // already answered
  exam_state.answers[question] = answer;
  const q = exam_state.questions[question];
  if (q.a === answer) {
    // right!
    exam_state.right++;
    document.getElementById(`answer-${question}-${answer}`).className = "right";
  } else {
    // wrong!
    exam_state.wrong++;
    document.getElementById(`answer-${question}-${answer}`).className = "wrong";
    document.getElementById(`answer-${question}-${q.a}`).className = "right";
  }
  exam_state.pending--;
  updateScore();
  updateExamStats();
}

function updateScore() {
  exam_state.score = Math.floor((exam_state.right/exam_state.questions.length) *6000) / 100;
}

const pages = document.querySelectorAll('section.page');
function gotoPage(page) {
  pages.forEach(p => p.style.display = "none");
  document.querySelectorAll('.page.' + page)[0].style.display = "block";
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

startExam();
</script>